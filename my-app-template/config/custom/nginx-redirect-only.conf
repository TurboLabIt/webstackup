## 🚨 WARNING 🚨
#
# This file is under version control!
# DO NOT EDIT DIRECTLY - If you do, you'll loose your changes!
#
# The original file is in `/var/www/my-app/config/custom/`
#
# You MUST:
#
# 1. edit the original file on you PC
# 2. Git-commit+push the changes
# 3. run `sudo bash /var/www/my-app/scripts/deploy.sh`
#
#
# 🪄 Based on https://github.com/TurboLabIt/webstackup/blob/master/my-app-template/config/custom/nginx-redirect-all.conf

map $request_uri $redirectMap {

  include /var/www/my-app/config/custom/redirects/all.txt
  ## default value will be an empty string
}


server {

  server_name my-app.com;
  
  ## 🏠 App directory
  #set $PROJECT_DIR /var/www/my-app;
  
   ## 🔏 Enable HTTPS
  include /usr/local/turbolab.it/webstackup/config/nginx/20_https_enable.conf;
  
  ## 🔓 Enable plain-HTTP (prevent automatic global redirect to HTTPS)
  listen *:80;

  ## 🔏 Fake HTTPS cetificates
  ssl_certificate /usr/local/turbolab.it/webstackup/autogenerated/https-localhost.crt;
  ssl_certificate_key /usr/local/turbolab.it/webstackup/autogenerated/openssl-private-key.pem;
  
  ## 🔏 To obtain a valid certificate from Let's Encrypt:
  # certbot --email info@my-app.com --agree-tos certonly --webroot -w /var/www/my-app/public -d my-app.com -d www.my-app.com -d statistiche.my-app.com
  #ssl_certificate /etc/letsencrypt/live/my-app.com/fullchain.pem;
  #ssl_certificate_key /etc/letsencrypt/live/my-app.com/privkey.pem;
  #ssl_trusted_certificate /etc/letsencrypt/live/my-app.com/cert.pem;
  
  ## 🚧 HTTP Auth on staging
  include /usr/local/turbolab.it/webstackup/config/nginx/30_httpauth.conf;
  
  ## 📃 Logging
  error_log /var/log/nginx/my-app_redirect-only_error.log;
  access_log /var/log/nginx/my-app_redirect-only_access.log;

  ## 💔 Enable custom 404 page
  include /usr/local/turbolab.it/webstackup/config/nginx/404-not-found.conf;

  ## 🧭 Redirect or 404
  set $redirectTo $redirectMap;
  if ($redirectTo) {
    return 301 $redirectTo;
  }
  
  ## if no valid redirect is found => return 404 with the custom page
}
