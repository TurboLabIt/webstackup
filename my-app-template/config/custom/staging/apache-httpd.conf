## 🚨 WARNING 🚨
#
# This file is under version control!
# DO NOT EDIT DIRECTLY - If you do, you'll loose your changes!
#
# The original file is in `/var/www/my-app/config/custom/staging/`
#
# You MUST:
#
# 1. edit the original file on you PC
# 2. Git-commit+push the changes
# 3. run `sudo bash /var/www/my-app/scripts/deploy.sh`
#
# ⚠️ This file is for the STAGING env only ⚠️
#
# 🪄 Based on https://github.com/TurboLabIt/webstackup/blob/master/my-app-template/config/custom/staging/apache-httpd.conf

## custom PHP-FPM definition (special cases only)
# include /var/www/my-app/config/custom/apache-httpd-php-fpm.conf;

<VirtualHost *:443>

  ServerName my-app.com
  
  ## 🏠 App directory
  Define PROJECT_DIR /var/www/my-app
  
  ## 🔏 Fake HTTPS cetificate
  SSLCertificateFile /usr/local/turbolab.it/webstackup/autogenerated/https-localhost.crt
  SSLCertificateKeyFile /usr/local/turbolab.it/webstackup/autogenerated/openssl-private-key.pem
  
  ## 🔏 To obtain a valid certificate from Let's Encrypt:
  # certbot --email info@my-app.com --agree-tos certonly --webroot -w /var/www/my-app/public -d my-app.com -d www.my-app.com -d statistiche.my-app.com
  #SSLCertificateFile /etc/letsencrypt/live/my-app.com/fullchain.pem;
  #SSLCertificateKeyFile /etc/letsencrypt/live/my-app.com/privkey.pem;
  
  ## 🚧 HTTP Auth on staging
  include /usr/local/turbolab.it/webstackup/config/apache-httpd/httpauth.conf;
  
  ## 🤖 Autodeploy on staging
  # https://github.com/TurboLabIt/webstackup/blob/master/script/php-pages/readme.md#how-to-autodeploy
  include /usr/local/turbolab.it/webstackup/config/apache-httpd/autodeploy-async.conf;
  
  ## 📜 Shared config
  include /var/www/my-app/config/custom/apache-httpd.conf;
 
</VirtualHost>


## redirect www.my-app.com to my-app.com
<VirtualHost *:443>

  ServerName www.my-app.com
  
  ## Enable HTTPS
  include /usr/local/turbolab.it/webstackup/config/apache-httpd/https_enable.conf;
  
  ## copy the certs from the actual <VirtualHost>
  SSLCertificateFile /usr/local/turbolab.it/webstackup/autogenerated/https-localhost.crt
  SSLCertificateKeyFile /usr/local/turbolab.it/webstackup/autogenerated/openssl-private-key.pem

  RewriteEngine On
  RewriteRule (.*) https://my-app.com$1 [NC,R=301,QSA,L]
  
</VirtualHost>
