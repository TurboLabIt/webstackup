## ğŸš¨ WARNING ğŸš¨
#
# This file is under version control!
# DO NOT EDIT DIRECTLY - If you do, you'll loose your changes!
#
# The original file is in `/var/www/my-app/config/custom/staging/`
#
# You MUST:
#
# 1. edit the original file on you PC
# 2. Git-commit+push the changes
# 3. run `sudo bash /var/www/my-app/scripts/deploy.sh`
#
# âš ï¸ This file is for the STAGING env only âš ï¸
#
# ğŸª„ Based on https://github.com/TurboLabIt/webstackup/blob/master/my-app-template/config/custom/staging/nginx.conf

## custom PHP-FPM definition (special cases only)
#include /var/www/my-app/config/custom/nginx-php-fpm.conf;

map $request_uri $wsuRedirectToMap_my-app {
  include /var/www/my-app/config/custom/redirects/redirect-map*.conf;
  ## default value will be an empty string
}


## MAIN server{} configuration
server {

  server_name my-app.com;

  ## ğŸ  App directory
  set $PROJECT_DIR /var/www/my-app;

  ## ğŸ” HTTPS certificate
  ssl_certificate /usr/local/turbolab.it/webstackup/autogenerated/https-localhost.crt;
  ssl_certificate_key /usr/local/turbolab.it/webstackup/autogenerated/openssl-private-key.pem;

  ## ğŸ” To obtain a valid certificate from Let's Encrypt:
  # run `webstackup`. Select `HTTPS certificates -> Let's Encrypt a domain`
  #ssl_certificate /etc/letsencrypt/live/my-app.com/fullchain.pem;
  #ssl_certificate_key /etc/letsencrypt/live/my-app.com/privkey.pem;
  #ssl_trusted_certificate /etc/letsencrypt/live/my-app.com/cert.pem;

  ## ğŸ” My App Name valid certificates
  #ssl_certificate /etc/ssl/current/my-app.crt;
  #ssl_certificate_key /etc/ssl/current/my-app.key;

  ## ğŸ“œ Shared config
  include /var/www/my-app/config/custom/nginx-frontend.conf;

  ## ğŸ” Enable HTTPS (disable if using varnish.conf below)
  # https://github.com/TurboLabIt/webstackup/blob/master/config/nginx/20_https_enable.conf
  include /usr/local/turbolab.it/webstackup/config/nginx/20_https_enable.conf;

  ## ğŸš§ HTTP auth on staging
  include /usr/local/turbolab.it/webstackup/config/nginx/30_httpauth.conf;
  # TODO: include the following in prod only
  #include /etc/turbolab.it/webstackup-nginx-allow-deny-list*.conf;

  ## ğŸ•µï¸ Prevent crawling on staging
  add_header X-Robots-Tag "noindex, nofollow, noarchive, nosnippet, noimageindex, notranslate";

  ## âš™ï¸ Application backend (disable if using varnish.conf below)
  include /var/www/my-app/config/custom/nginx-backend.conf;

  ## ğŸª£ SSL Terminator for Varnish
  ## https://github.com/TurboLabIt/webstackup/blob/master/config/nginx/varnish.conf
  #include /usr/local/turbolab.it/webstackup/config/nginx/varnish.conf;

  ## ğŸ›£ï¸ Reverse proxy to Apache HTTP Server on port 44344
  #set $proxy_pass_target https://127.0.0.1:44344;
  #include /usr/local/turbolab.it/webstackup/config/nginx/25_reverse-proxy.conf;
}


## ğŸª£ Application backend for Varnish
#server {

  #listen 127.0.0.1:8080;
  #server_name my-app.com;

  ## ğŸ  App directory
  #set $PROJECT_DIR /var/www/my-app;

  ## ğŸ“œ Shared config
  #include /var/www/my-app/config/custom/nginx-backend.conf;
#}


## redirect www.my-app.com to my-app.com
server {

  server_name www.my-app.com;

  ## Enable HTTPS
  include /usr/local/turbolab.it/webstackup/config/nginx/20_https_enable.conf;

  ## copy the certs from the actual server{}
  ssl_certificate /usr/local/turbolab.it/webstackup/autogenerated/https-localhost.crt;
  ssl_certificate_key /usr/local/turbolab.it/webstackup/autogenerated/openssl-private-key.pem;

  return 301 https://my-app.com$request_uri;
}


## redirect my-app.com to www.my-app.com
#server {

  #server_name my-app.com;

  ## Enable HTTPS
  #include /usr/local/turbolab.it/webstackup/config/nginx/20_https_enable.conf;

  ## copy the certs from the actual server{}
  #ssl_certificate /usr/local/turbolab.it/webstackup/autogenerated/https-localhost.crt;
  #ssl_certificate_key /usr/local/turbolab.it/webstackup/autogenerated/openssl-private-key.pem;

  #return 301 https://www.$host$request_uri;
#}
