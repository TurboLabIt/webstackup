#!/usr/bin/env bash
### AUTOMATIC PHP INSTALLER BY WEBSTACK.UP
# https://github.com/TurboLabIt/webstackup/tree/master/script/php/install.sh
#
# sudo apt install curl -y && curl -s https://raw.githubusercontent.com/TurboLabIt/webstackup/master/script/php/install.sh?$(date +%s) | sudo PHP_VER=8.2 bash
#
# Based on: https://turbolab.it/1380

## bash-fx
if [ -f "/usr/local/turbolab.it/bash-fx/bash-fx.sh" ]; then
  source "/usr/local/turbolab.it/bash-fx/bash-fx.sh"
else
  source <(curl -s https://raw.githubusercontent.com/TurboLabIt/bash-fx/main/bash-fx.sh)
fi
## bash-fx is ready

fxHeader "ðŸ’¿ PHP installer"
rootCheck

if [ -z "${PHP_VER}" ]; then
  fxCatastrophicError "PHP_VER is undefined! Cannot determine which version of PHP to install"
fi


fxTitle "Removing any old previous instance of PHP ${PHP_VER}..."
apt purge --auto-remove php${PHP_VER}* -y
rm -rf /etc/php/${PHP_VER}


## installing/updating WSU
WSU_DIR=/usr/local/turbolab.it/webstackup/
if [ ! -f "${WSU_DIR}setup.sh" ]; then
  curl -s https://raw.githubusercontent.com/TurboLabIt/webstackup/master/setup.sh?$(date +%s) | sudo bash
fi

PHP_VER_REQUESTED=${PHP_VER}
source "${WSU_DIR}script/base.sh"
PHP_VER=${PHP_VER_REQUESTED}


fxTitle "Installing prerequisites..."
apt update -qq
apt install software-properties-common -y


fxTitle "Setting up ondrej/php..."
LC_ALL=C.UTF-8 add-apt-repository ppa:ondrej/php -y
apt update -qq


fxTitle "Installing..."
apt install -y \
  php${PHP_VER}-fpm php${PHP_VER}-cli php${PHP_VER}-common \
  php${PHP_VER}-mbstring php${PHP_VER}-gd php${PHP_VER}-intl \
  php${PHP_VER}-xml php${PHP_VER}-mysql php${PHP_VER}-zip php${PHP_VER}-curl


fxTitle "Config path"
FPM_CONF_FILE=/etc/php/${PHP_VER}/fpm/conf.d/30-webstackup-
CLI_CONF_FILE=/etc/php/${PHP_VER}/cli/conf.d/30-webstackup-
echo "FPM file(s): ${FPM_CONF_FILE}"
echo "CLI file(s): ${CLI_CONF_FILE}"


wsuMkAutogenDir


fxTitle "Storing the selected version..."
echo "set \$PHP_VER ${PHP_VER};"  > "${WEBSTACKUP_AUTOGENERATED_DIR}nginx-php_ver.conf"
echo "PHP_VER=${PHP_VER}" >> "${WEBSTACKUP_AUTOGENERATED_DIR}variables.sh"
echo "PHP_FPM=php${PHP_VER}-fpm" >> "${WEBSTACKUP_AUTOGENERATED_DIR}variables.sh"
echo "PHP_CLI=/usr/bin/php${PHP_VER}" >> "${WEBSTACKUP_AUTOGENERATED_DIR}variables.sh"


fxTitle "Activating custom php.ini..."  
ln -s  "${WEBSTACKUP_INSTALL_DIR}config/php/php-custom.ini" ${FPM_CONF_FILE}custom.ini
ln -s  "${WEBSTACKUP_INSTALL_DIR}config/php/php-custom.ini" ${CLI_CONF_FILE}custom.ini

fxTitle "Disabling execution function from FPM..."  
ln -s  "${WEBSTACKUP_INSTALL_DIR}config/php/no-exec.ini" ${FPM_CONF_FILE}no-exec.ini

fxTitle "Setting timezone to Italy..."
ln -s  "${WEBSTACKUP_INSTALL_DIR}config/php/timezone-italy.ini" ${FPM_CONF_FILE}timezone-italy.ini
ln -s  "${WEBSTACKUP_INSTALL_DIR}config/php/timezone-italy.ini" ${CLI_CONF_FILE}timezone-italy.ini
fxInfo "Different timezone? rm -rf ${FPM_CONF_FILE}timezone-italy.ini ${CLI_CONF_FILE}timezone-italy.ini"

fxTitle "Removing all limits from CLI..."
ln -s  "${WEBSTACKUP_INSTALL_DIR}config/php/unlimited.ini" ${CLI_CONF_FILE}unlimited.ini

fxTitle "Disable cgi.fix_pathinfo from FPM..."
ln -s  "${WEBSTACKUP_INSTALL_DIR}config/php/no-cgi.fix_pathinfo.ini" ${FPM_CONF_FILE}no-cgi.fix_pathinfo.ini

fxTitle "Enable OPcache..."
ln -s  "${WEBSTACKUP_INSTALL_DIR}config/php/opcache.ini" ${FPM_CONF_FILE}opcache.ini


fxTitle "Activating custom php-fpm pool settings..."
if [ "$INSTALLED_RAM" -gt "6000" ]; then

  echo "RAM: ${INSTALLED_RAM}: using fpm-pool-32GB.conf"
  ln -s "${WEBSTACKUP_INSTALL_DIR}config/php/fpm-pool-32GB.conf" /etc/php/${PHP_VER}/fpm/pool.d/webstackup-fpm-pool-32GB.conf

else

  echo "RAM: ${INSTALLED_RAM}: this is a small server! Using fpm-pool-1GB.conf"
  ln -s "${WEBSTACKUP_INSTALL_DIR}config/php/fpm-pool-1GB.conf" /etc/php/${PHP_VER}/fpm/pool.d/webstackup-fpm-pool-1GB.conf
fi


fxTitle "Assigning the nginx user to www-data group..."
if id "nginx" &>/dev/null; then

  usermod -a -G www-data nginx
  nginx -t && service nginx restart

else

  fxInfo "nginx user doesn't exist"
fi


fxTitle "Create the socket directory..."
mkdir -p /run/php/


fxTitle "Starting php-fpm service..."
/usr/sbin/php-fpm${PHP_VER} -t && service php${PHP_VER}-fpm restart
systemctl --no-pager status php${PHP_VER}-fpm

  
fxTitle "Linking the PHP-FPM socket as php-fpm.sock..."
if [ ! -e "/run/php/php-fpm.sock" ]; then

  ln -s /run/php/php${PHP_VER}-fpm.sock /run/php/php-fpm.sock

else

  fxInfo "Link already exists"
  ls -l "/run/php/php-fpm.sock"
fi


fxEndFooter
