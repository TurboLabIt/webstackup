#!/bin/bash
clear

source "/usr/local/turbolab.it/webstackup/script/base.sh"
printHeader "üõ°Ô∏è persona-non-grata"
rootCheck

printMessage "Removing previous rules and disable the firewall..."
sudo ufw --force reset

printMessage "üêß Allow SSH..."
ufw allow 22/tcp

printMessage "üíå Allow SMTP..."
ufw allow 25/tcp

printMessage "üåé Allow HTTP(s)..."
ufw allow 80,443/tcp

printMessage "‚è¨ Downloading IP block list..."
IP_BLACKLIST_FULLPATH=${WEBSTACKUP_AUTOGENERATED_DIR}persona-non-grata.txt
curl -Lo "${IP_BLACKLIST_FULLPATH}" https://raw.githubusercontent.com/TurboLabIt/webstackup/master/config/firewall/persona-non-grata.txt

printMessage "Insert a dummy rule (it's needed for scripting)"
ufw deny from 95.141.35.37 to any

while read -r line || [[ -n "$line" ]]; do
  FIRSTCHAR="${line:0:1}"
  if [ "$FIRSTCHAR" != "#" ] && [ "$FIRSTCHAR" != "" ]; then
    echo "Blocking: $line"
    ufw insert 1 deny from $line to any
  fi	
done < "$IP_BLACKLIST_FULLPATH"

printMessage "Remove the dummy rule"
ufw delete deny from 95.141.35.37 to any

printMessage "üî•üî• Shields up! Activating the firewall..."
ufw --force enable 
ufw status

printMessage "üßπ Removing backup file..."
sudo rm -f /etc/ufw/user.rules.* /etc/ufw/before.rules.* /etc/ufw/after.rules.*
sudo rm -f /etc/ufw/user6.rules.* /etc/ufw/before6.rules.* /etc/ufw/after6.rules.*

printMessage "persona-non-grata is done"
